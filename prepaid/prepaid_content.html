<!DOCTYPE html>
<html class="um  landscape min-width-240px min-width-320px min-width-480px min-width-768px min-width-1024px" ontouchstart>

    <head>
        <title></title>
        <meta charset="utf-8">
        <meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <link rel="stylesheet" href="../common/css/fonts/font-awesome.min.css">
        <link rel="stylesheet" href="../common/css/ui-box.css">
        <link rel="stylesheet" href="../common/css/ui-base.css">
        <link rel="stylesheet" href="../common/css/ui-color.css">
        <link rel="stylesheet" href="../common/css/appcan.icon.css">
        <link rel="stylesheet" href="../common/css/appcan.control.css">
        <link rel="stylesheet" href="prepaid_content/css/main.css">
        <link rel="stylesheet" href="../common/css/app.css">
    </head>

    <body class="bc-bg" ontouchstart style="background-color: #EEEEEE;">

        <div class="ub ub-ac ub-pc  input_num">
            <div class="ub ub-ac ub-pc ">
                <img src="prepaid_content/css/myImg/phone.png" class="ub phoneimg" />
            </div>
            <div id="" class="ub ub-ac ub-pc ub-f1">
                <div class="ub ub-f1 uinput uinn">
                    <input placeholder="填写要充值的手机号" id="Fphone" value="" name="Fphone" type="text" class=" common-font-color2">
                </div>
            </div>
            <div class="ub ub-ac ub-pc">
                <img src="prepaid_content/css/myImg/delete.png" class="ub deletepic" onclick="deleteval()" />
            </div>
        </div>

        <div class="ub  selectpay">

            <div class="ub ub-ac ub-pc" style="padding-left: 1em;">
                购买方式:
            </div>
            <div class="" style="padding-left: 0.5em;">
                <div class="ub ub-ac ub-pc">
                    <div class="ub ub-f1 " id="mode">
                        <div id="mode1" class="clsitem" onclick="payclsitemclick('mode','mode1')">
                            <div style="margin-left: 0.7em; margin-right: 0.7em;" myid="1" class="shop-content-fontallco2">
                                大学生分期付
                            </div>
                            <img src="../images/checked.png" class="clitemimg" />
                        </div>
                        <div id="mode2" class="clsitem seller-content-mar" onclick="payclsitemclick('mode','mode2')">
                            <div style="margin-left: 0.7em; margin-right: 0.7em;" myid="2" class="shop-content-fontallco2">
                                自己付
                            </div>
                            <img src="../images/checked.png" class="clitemimg" />
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <div class="ub ub-ac" style="margin-left: 1em;color: #979797;">
            选择充值金额
        </div>
        <div id="total">
            <div style="margin-top: 0.6em;">
                <div class="select-month ub ub-ac ub-pc">
                    <div class="ub ub-ac ub-pc">
                        <div class="ub ub-f1" id="values">
                            <div id="phoneva1" class="ub clsitem" onclick="clsitemclick('values','phoneva1')">
                                <div style="margin-left: 1em; " myid="1" class="shop-content-fontallco2 getselect itemval1">
                                    10
                                </div>
                                <div style="margin-right: 1em;">
                                    元
                                </div>
                                <img src="../images/checked.png" class="clitemimg" />
                            </div>
                            <div id="phoneva2" class="ub clsitem seller-content-mar" onclick="clsitemclick('values','phoneva2')">
                                <div style="margin-left: 1em; " myid="2" class="shop-content-fontallco2 getselect itemval2">
                                    50
                                </div>
                                <div style="margin-right: 1em;">
                                    元
                                </div>
                                <img src="../images/checked.png" class="clitemimg" />
                            </div>
                            <div id="phoneva3" class="ub clsitem seller-content-mar" onclick="clsitemclick('values','phoneva3')">
                                <div style="margin-left: 1em; " myid="2" class="shop-content-fontallco2 getselect itemval3">
                                    100
                                </div>
                                <div style="margin-right: 1em;">
                                    元
                                </div>
                                <img src="../images/checked.png" class="clitemimg" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="monthtext" class="ub ub-ac" style="margin-top: 0.6em;margin-left: 1em;color: #979797;">
                选择分期月数
            </div>
            <div id="forhidden" class="ub ub-ac ub-pc" style="margin-top: 0.6em;background-color: #FFFFFF;">
                <div class="select-month ub ub-ver ub-ac ub-pc ub-f1" id="monthtotal">
                    <div class="ub ub-ac ub-pc">
                        <div class="ub ub-pj ub-f1 ">
                            <div id="month1" class="ub clsitem" onclick="clsitemclick('monthtotal','month1')">
                                <div style="margin-left: 1em;" myid="1" class="shop-content-fontallco2 selectmonth">
                                    1
                                </div>
                                <div style=" margin-right: 1em;">
                                    个月
                                </div>
                                <img src="../images/checked.png" class="clitemimg" />
                            </div>
                            <div id="month2" class="ub clsitem seller-content-mar" onclick="clsitemclick('monthtotal','month2')">
                                <div style="margin-left: 1em;" myid="2" class="shop-content-fontallco2 selectmonth">
                                    2
                                </div>
                                <div style="margin-right: 1em;">
                                    个月
                                </div>
                                <img src="../images/checked.png" class="clitemimg" />
                            </div>
                            <div id="month3" class="ub clsitem seller-content-mar" onclick="clsitemclick('monthtotal','month3')">
                                <div style="margin-left: 1em;" myid="2" class="shop-content-fontallco2 selectmonth">
                                    3
                                </div>
                                <div style=" margin-right: 1em;">
                                    个月
                                </div>
                                <img src="../images/checked.png" class="clitemimg" />
                            </div>
                        </div>
                    </div>
                    <div class="ub ub-pc ub-ac">
                        <div class="ub ub-pj ub-f1 seller-content-mar1">
                            <div id="month4" class="ub clsitem" onclick="clsitemclick('monthtotal','month4')">
                                <div style="margin-left: 1em;" myid="1" class="shop-content-fontallco2 selectmonth">
                                    4
                                </div>
                                <div style=" margin-right: 1em;">
                                    个月
                                </div>
                                <img src="../images/checked.png" class="clitemimg" />
                            </div>
                            <div id="month5" class="ub clsitem seller-content-mar" onclick="clsitemclick('monthtotal','month5')">
                                <div style="margin-left: 1em;" myid="2" class="shop-content-fontallco2 selectmonth">
                                    5
                                </div>
                                <div style="margin-right: 1em;">
                                    个月
                                </div>
                                <img src="../images/checked.png" class="clitemimg" />
                            </div>
                            <div id="month6" class="ub clsitem seller-content-mar" onclick="clsitemclick('monthtotal','month6')">
                                <div style="margin-left: 1em; " myid="2" class="shop-content-fontallco2 selectmonth">
                                    6
                                </div>
                                <div style="margin-right: 1em;">
                                    个月
                                </div>
                                <img src="../images/checked.png" class="clitemimg" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="valhidden" class="ub" style="margin-top: 0.5em;margin-left: 1em;color: #979797;">
            <div class="ub">
                <div>
                    月供：
                </div>
                <div class="moneycolor monthmoneyval">
                    100
                </div>
                <div>
                    元
                </div>
            </div>
            <!--<div class="ub" style="padding-left: 1em;">
            <div>
            服务费：
            </div>
            <div class="moneycolor fee">
            5
            </div>
            <div>
            元
            </div>
            </div>-->
        </div>
        <div class="ub" style="margin-top: 0.5em;margin-left: 1em;font-size: 1.1em;margin-bottom: 0.5em;">
            <div>
                充值金额：
            </div>
            <div id="selectmoney" class="moneycolor">

            </div>
            <div>
                元
            </div>
        </div>
        <div class="ub ub-ver" style="background-color: #F5F5F3;">
            <div class="ub umar-a ub-ac" style="padding: 0.7em 0 0 1em;">
                <div class="checkbox checked-font-size">
                    <input type="checkbox" name="checkset" id="checkset" class="uabs ub-con" checked="checked">
                    </input>
                </div>
                <div class="lv_title ub-f1 marg-l ub  ut-m line1" style="color: #37c6c8;">
                    <div style="color:#787875; font-weight: bolder">
                        同意
                    </div>
                    <div id="agreement">
                        《分期付协议》
                    </div>
                </div>

            </div>
            <div class="uinn-at1" style="padding:1em 1em 0 1em;">
                <div class="btn ub ub-ac bc-text-head ub-pc bc-btn uc-a1 ulev1" id="submit">
                    立即充值
                </div>
            </div>
        </div>
        <script src="../common/js/jquery-1.7.1.min.js"></script>
        <script src="../common/js/appcan.js"></script>
        <script src="../common/js/appcan.control.js"></script>
        <script src="../common/js/yfkj.js"></script>

    </body>
    <script> 
        FeveryRate = '';
        FserviceRate = '';
        var FshoperId = "";
        moneysval = '';
        monthsval = '';
        var pid = '';
        var paymethod = '';
        var Fmoney = 0;
        appcan.ready(function() {
            getPhone();
            findRate();
            findConsumedMoney();
            appcan.window.subscribe('toastpassowrd', function(msg) {
                appcan.window.openToast(msg, '1000');
            });
            appcan.window.subscribe('subphone', function(msg) {
                Recharge();
            });
            payclsitemclick("mode", "mode1");
            clsitemclick("values", "phoneva1");
            clsitemclick("monthtotal", "month1");
        });
        //服务费利率、月手续费利率查询
        function findRate() {
            appcan.ajax({
                url : Serverurl + "/user/findRate",
                type : "POST",
                dataType : 'json',
                success : function(result) {
                    var data = result.Data[0];
                    FeveryRate = data.FeveryRate;
                    FserviceRate = data.FserviceRate;
                    payclsitemclick("mode", "mode1");
                    clsitemclick("values", "phoneva1");
                    clsitemclick("monthtotal", "month1");
                },
                error : function(e) {
                    appcan.window.openToast('服务器出错!', '500');
                }
            });
        }
          //查询可消费金额
        function findConsumedMoney() {
            var datas = {
                FuserId : getuserid()
            };
            appcan.ajax({
                url : Serverurl + "/user/findConsumedMoney",
                type : "POST",
                dataType : 'json',
                data : datas,
                success : function(result) {
                    var data = result.Data[0];
                    if (result.Msg == '1') {
                        Fmoney = Number(data.Fusemoney);
                       
                    }
                },
                error : function(e) {
                    appcan.window.openToast('服务器出错!', '500');
                }
            });
        }

        //服务费利率、月手续费利率查询
        function getPhone() {
            appcan.ajax({
                url : Serverurl + "/user/getPhone",
                type : "POST",
                dataType : 'json',
                data : {
                    FuserId : getuserid()
                },
                success : function(result) {
                    var data = result.Data[0];
                    $("#Fphone").val(data.Fphone)
                },
                error : function(e) {
                    appcan.window.openToast('服务器出错!', '500');
                }
            });
        }

        function clsitemclick(pid, id) {
            $("#" + pid + " .clsitem").removeClass("clsitemselectdiv");
            $("#" + pid + " .clsitem img").removeClass("clsitemselectimg");
            $("#" + id).addClass("clsitemselectdiv");
            $("#" + id + " img").addClass("clsitemselectimg");
            getSelectVal(pid);
        }

        function deleteval() {
            $("#Fphone").val('');
        }

        function payclsitemclick(pid, id) {
           
            $("#" + pid + " .clsitem").removeClass("clsitemselectdiv");
            $("#" + pid + " .clsitem img").removeClass("clsitemselectimg");
            $("#" + id).addClass("clsitemselectdiv");
            $("#" + id + " img").addClass("clsitemselectimg");
            if ($("#" + pid + " .clsitemselectdiv div").attr("myid") == 2) {
                $("#agreement").text("《服务协议》");
                $("#forhidden").addClass("uhide");
                $("#valhidden").addClass("uhide");
                $("#monthtext").addClass("uhide");
                 $(".itemval1").text(10);
                $(".itemval2").text(50);
                $(".itemval3").text(100);
                clsitemclick("values", "phoneva1");
                // $("#phoneva1").removeClass("uhide");
               // $("#phoneva2").removeClass("uhide");
                paymethod = 'selfpay';
            } else if ($("#" + pid + " .clsitemselectdiv div").attr("myid") == 1) {
                $("#forhidden").removeClass("uhide");
                $("#valhidden").removeClass("uhide");
                $("#monthtext").removeClass("uhide");
                $(".itemval1").text(100);
                $(".itemval2").text(200);
                $(".itemval3").text(300);
                  $("#agreement").text("《分期付协议》");
                clsitemclick("values", "phoneva1");
               // $("#phoneva1").addClass("uhide");
                //$("#phoneva2").addClass("uhide");
                paymethod = 'pointspay';
            }
        }

        //协议合同按钮
        appcan.button("#agreement", "btn-act", function() {
            if ($("#FwithdrawMoney").val() == "") {
                appcan.window.openToast("请输入消费金额", "1000");
                return;
            }
            if (paymethod == 'pointspay') {
                var datas = {
                    FwithdrawMoney : $("#selectmoney").text(), //消费金额
                    FpointsId : monthsval.trim(), //分期月数
                    FuserId : getuserid()
                };
                appcan.locStorage.setVal("takecontract", datas);
                appcan.window.open("pact", "../contract/pact/pact.html");
            } else if (paymethod == 'selfpay') {
                appcan.window.open("agreement", "../agreement/agreement.html");
            }
        })
        function getSelectVal(pid) {
            var lists = $("#total");
            var activelists = lists.find("#" + pid + " .clsitemselectdiv");
            activelists.each(function(i, item) {
                if (pid == 'values') {
                    moneysval = $(item).find(".getselect").text();
                    $("#selectmoney").text(moneysval);
                } else if (pid == 'monthtotal') {
                    monthsval = $(item).find(".selectmonth").text();
                }
            });
            getMoneyval(moneysval, monthsval);
        }

        function getMoneyval(moneysval, monthsval) {
            var fee = Number(moneysval) * Number(FserviceRate);
            $(".fee").text(fee);
            $(".monthmoneyval").text(((Number(moneysval) + Number(moneysval) * FeveryRate) / Number(monthsval)).toFixed(2));
        }

        //分期付按钮
        appcan.button("#submit", "ani-act", function(a, b) {

            if (!$("#checkset").prop("checked")) {
                appcan.window.openToast("请阅读协议", "1000");
                return;
            }
            if ($("#Fphone").val() == "") {
                appcan.window.openToast("请输入充值手机号码", "1000");
                return;
            }
            if (paymethod == 'pointspay') {
                if (cheackstat() == 0) {
                    return;
                }
                if(Number($("#selectmoney").text()) > Number(Fmoney)){
                 appcan.window.openToast("您的可消费金额不足！", "1000");
                 return;
                }
                var fejiao = $("#selectmoney").text();
                appcan.locStorage.setVal("fejiao", fejiao);
                appcan.window.open({
                    name : 'subpassword',
                    dataType : 0,
                    data : '../subphonepassword/subphonepassword.html',
                    aniId : 12,
                    type : 256
                });
                //consumedOrder();
            } else if (paymethod == 'selfpay') {
                ownerPayConsume();
            }
        })
        //自己付   提交到后台的数据
        function ownerPayConsume() {
            if (!$("#checkset").prop("checked")) {
                appcan.window.openToast("请阅读协议", "500");
                return;
            }
            if ($("#selectmoney").text() == "") {
                appcan.window.openToast("请选择充值金额", "1000");
                return;
            }
            var selfdatas = {
                Fphone : ($("#Fphone").val()).trim(),
                FwithdrawMoney : $("#selectmoney").text(), //消费金额
                FWithdrawalsName : '话费充值', //消费订单名
                Fpaystates : 2
            };
            appcan.locStorage.setVal("selfdatas", selfdatas);
            appcan.window.open("selfpay", "../billpayback/selfpay.html");
        }

        //  分期付     提交到后台的数据
        function consumedOrder() {
            // alert("cc");
            //alert(paymethod);
            var FWithdrawalsName = $("#FWithdrawalsName").val();
            var phone=($("#Fphone").val()).trim()
            if (FWithdrawalsName == '') {
                appcan.window.openToast("请输入手机号", 1000);
            }
            if (phone && /^1[3|4|5|8]\d{9}$/.test(phone)) {
            } else {
                appcan.window.openToast("不是有效的手机号", 2000, 5);
                return;
            }
            var datas = {
                Fphone : ($("#Fphone").val()).trim(),
                FwithdrawMoney : ($("#selectmoney").text()).trim(), //消费金额
                FpointsId : monthsval.trim(), //分期月数
                FuserId : getuserid(),
                FWithdrawalsName : '话费充值',
                FshoperId : ''
            };
            appcan.ajax({
                url : Serverurl + "/user/consumedOrder",
                type : "POST",
                dataType : 'json',
                data : datas,
                success : function(result) {

                    if (result == '1') {
                        appcan.window.openToast('提现信息提交成功', '1000');
                        appcan.locStorage.setVal("orderindex", 2);
                        appcan.window.open("myorder", "../myorder/order.html");
                        appcan.window.evaluateScript({

                            name : 'prepaid',
                            scriptContent : 'windowclose()'
                        });

                    } else if (result == '2') {
                        appcan.window.openToast('可消费金额不足', '1000');
                    }
                },
                error : function(e) {
                    appcan.window.openToast('服务器出错!', '1000');
                }
            });
        }

        function Recharge() {
            var num = new  Date().getTime();
            var phone =($("#Fphone").val()).trim();
            var FwithdrawMoney = ($("#selectmoney").text()).trim();
            appcan.ajax({
                url : Serverurl + "/Phonebill/Recharge",
                type : "POST",
                dataType : 'json',
                data : {
                    phoneno : phone,
                    orderid : num,
                    cardnum : FwithdrawMoney
                },
                success : function(result) {
                    if (result.Msg == 1) {
                        consumedOrder();
                    } else {
                        appcan.window.openToast(result.Data, '2000');
                    }
                },
                error : function(e) {
                    appcan.window.openToast('服务器出错!', '500');
                }
            });
        }
    </script>

</html>